<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crown Patent Identifier Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: #333;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .page-container {
            min-height: 100vh;
            padding: 2rem 0;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #dee2e6;
            z-index: 1;
        }

        .step:first-child::before {
            left: 50%;
        }

        .step:last-child::before {
            right: 50%;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #dee2e6;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            position: relative;
            z-index: 2;
            font-weight: bold;
        }

        .step.active .step-circle {
            background: var(--secondary-color);
            color: white;
        }

        .step.completed .step-circle {
            background: var(--success-color);
            color: white;
        }

        .api-key-input {
            position: relative;
        }

        .api-key-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: none;
            color: #6c757d;
        }

        .feature-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .feature-item:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.1);
        }

        .patent-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .score-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: bold;
        }

        .score-high { background: var(--danger-color); color: white; }
        .score-medium { background: var(--warning-color); color: white; }
        .score-low { background: var(--success-color); color: white; }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }

        .hidden { display: none !important; }

        .feature-mapping-table {
            font-size: 0.9rem;
        }

        .feature-mapping-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
        }

        .feature-mapping-table td {
            vertical-align: middle;
            padding: 1rem;
        }

        .feature-mapping-table .table-success {
            background-color: rgba(40, 167, 69, 0.1) !important;
            border-left: 4px solid #28a745;
        }

        .feature-mapping-table .table-light {
            background-color: rgba(248, 249, 250, 0.8) !important;
            border-left: 4px solid #dee2e6;
        }

        .match-score {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .feature-details {
            font-size: 0.85rem;
            color: #6c757d;
            font-style: italic;
        }

        .claim-element-header {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 0.5rem;
            border-radius: 5px;
            margin-bottom: 0.5rem;
        }

        /* Professional Navigation Styling */
        .navbar-nav .nav-link {
            transition: all 0.3s ease;
            border-radius: 20px;
            margin: 0 5px;
            padding: 8px 16px !important;
        }

        .navbar-nav .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .navbar-nav .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }

        /* Workflow Steps Styling */
        .workflow-step {
            transition: all 0.3s ease;
            padding: 10px;
            border-radius: 10px;
        }

        .workflow-step:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: translateX(5px);
        }

        /* Feature Icons */
        .feature-icon {
            transition: all 0.3s ease;
        }

        .feature-icon:hover {
            transform: scale(1.1);
        }

        /* Professional Cards */
        .professional-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .professional-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        /* Export Dropdown */
        .dropdown-menu {
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-radius: 10px;
        }

        .dropdown-item {
            transition: all 0.3s ease;
            border-radius: 5px;
            margin: 2px 5px;
        }

        .dropdown-item:hover {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
            transform: translateX(5px);
        }

        /* Status Badges */
        .status-badge {
            font-size: 0.9rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
        }

        /* Progress Enhancement */
        .progress {
            height: 10px;
            border-radius: 10px;
            background: rgba(0,0,0,0.1);
        }

        .progress-bar {
            border-radius: 10px;
            transition: width 0.6s ease;
        }

        /* Professional Table */
        .professional-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .professional-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.2rem;
            }

            .card-header h2 {
                font-size: 1.5rem;
            }

            .feature-mapping-table {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="goToPage(1)">
                <i class="fas fa-crown me-2"></i>
                Crown Patent Identifier Pro
            </a>

            <!-- Navigation Menu -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="goToPage(1)" id="nav-step1">
                            <i class="fas fa-key me-1"></i>API Setup
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="goToPage(2)" id="nav-step2">
                            <i class="fas fa-search me-1"></i>Product Analysis
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="goToPage(3)" id="nav-step3">
                            <i class="fas fa-file-alt me-1"></i>Portfolio Patents
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="goToPage(4)" id="nav-step4">
                            <i class="fas fa-crown me-1"></i>Crown Patent Analysis
                        </a>
                    </li>
                </ul>

                <div class="navbar-nav">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-1"></i>Export
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportToJSON()">
                                <i class="fas fa-file-code me-2"></i>Export JSON
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportToCSV()">
                                <i class="fas fa-file-csv me-2"></i>Export CSV
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf me-2"></i>Export PDF
                            </a></li>
                        </ul>
                    </div>

                    <span class="navbar-text ms-3">
                        <i class="fas fa-chart-line me-1"></i>
                        Crown Patent Discovery Tool
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Progress Steps -->
    <div class="container mt-4">
        <div class="progress-steps">
            <div class="step active" id="step1">
                <div class="step-circle">1</div>
                <div class="step-label">API Setup</div>
            </div>
            <div class="step" id="step2">
                <div class="step-circle">2</div>
                <div class="step-label">Product Analysis</div>
            </div>
            <div class="step" id="step3">
                <div class="step-circle">3</div>
                <div class="step-label">Patent Research</div>
            </div>
            <div class="step" id="step4">
                <div class="step-circle">4</div>
                <div class="step-label">Infringement Analysis</div>
            </div>
        </div>
    </div>

    <!-- Page 1: API Configuration -->
    <div class="page active" id="page1">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header text-center">
                            <h2><i class="fas fa-key me-2"></i>API Configuration</h2>
                            <p class="mb-0">Configure your Google AI API key to identify crown patents</p>
                        </div>
                        <div class="card-body p-4">
                            <!-- API Key Configuration -->
                            <div class="mb-4">
                                <label for="googleApiKey" class="form-label">
                                    <i class="fab fa-google me-2"></i>Google AI API Key
                                </label>
                                <div class="api-key-input">
                                    <input type="password" class="form-control" id="googleApiKey" 
                                           placeholder="Enter your Google AI API key">
                                    <button type="button" class="api-key-toggle" onclick="toggleApiKeyVisibility()">
                                        <i class="fas fa-eye" id="apiKeyToggleIcon"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    Your API key is stored locally and never sent to our servers.
                                </div>
                            </div>

                            <!-- Test API Button -->
                            <div class="mb-4">
                                <button class="btn btn-outline-primary" onclick="testApiKey()">
                                    <i class="fas fa-vial me-2"></i>Test API Key
                                </button>
                                <div id="apiTestResult" class="mt-2"></div>
                            </div>

                            <!-- Detailed Instructions -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="alert alert-info h-100">
                                        <h5><i class="fas fa-info-circle me-2"></i>How to Get Your Google AI API Key</h5>
                                        <ol class="mb-3">
                                            <li>Visit <a href="https://makersuite.google.com/app/apikey" target="_blank" class="fw-bold">Google AI Studio</a></li>
                                            <li>Sign in with your Google account</li>
                                            <li>Click <span class="badge bg-primary">"Create API Key"</span></li>
                                            <li>Select <span class="badge bg-secondary">"Create API key in new project"</span></li>
                                            <li>Copy the generated API key</li>
                                            <li>Paste it in the field above and test</li>
                                        </ol>
                                        <div class="alert alert-warning mb-0">
                                            <small><i class="fas fa-exclamation-triangle me-1"></i>
                                            <strong>Important:</strong> Keep your API key secure. It's stored locally in your browser and never sent to our servers.</small>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="alert alert-success h-100">
                                        <h5><i class="fas fa-rocket me-2"></i>Crown Patent Discovery Workflow</h5>
                                        <div class="workflow-steps">
                                            <div class="workflow-step mb-3">
                                                <div class="d-flex align-items-start">
                                                    <span class="badge bg-primary rounded-pill me-2">1</span>
                                                    <div>
                                                        <strong>API Configuration</strong>
                                                        <p class="mb-0 small">Set up Google AI API key for intelligent crown patent analysis</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="workflow-step mb-3">
                                                <div class="d-flex align-items-start">
                                                    <span class="badge bg-info rounded-pill me-2">2</span>
                                                    <div>
                                                        <strong>Product Analysis</strong>
                                                        <p class="mb-0 small">Define your product features to identify relevant crown patents</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="workflow-step mb-3">
                                                <div class="d-flex align-items-start">
                                                    <span class="badge bg-warning rounded-pill me-2">3</span>
                                                    <div>
                                                        <strong>Portfolio Patents</strong>
                                                        <p class="mb-0 small">Upload your patent portfolio for crown patent identification</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="workflow-step">
                                                <div class="d-flex align-items-start">
                                                    <span class="badge bg-success rounded-pill me-2">4</span>
                                                    <div>
                                                        <strong>Crown Patent Analysis</strong>
                                                        <p class="mb-0 small">Identify and rank crown patents based on feature coverage</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Features Overview -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card border-0" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                        <div class="card-body">
                                            <h5 class="card-title text-center mb-4">
                                                <i class="fas fa-crown me-2 text-warning"></i>
                                                Crown Patent Discovery Features
                                            </h5>
                                            <div class="row">
                                                <div class="col-md-3 text-center mb-3">
                                                    <div class="feature-icon mb-2">
                                                        <i class="fas fa-brain fa-2x text-primary"></i>
                                                    </div>
                                                    <h6>AI-Powered Analysis</h6>
                                                    <small class="text-muted">Advanced AI to identify crown patents from your portfolio</small>
                                                </div>
                                                <div class="col-md-3 text-center mb-3">
                                                    <div class="feature-icon mb-2">
                                                        <i class="fas fa-upload fa-2x text-success"></i>
                                                    </div>
                                                    <h6>Portfolio Processing</h6>
                                                    <small class="text-muted">Bulk analyze entire patent portfolios efficiently</small>
                                                </div>
                                                <div class="col-md-3 text-center mb-3">
                                                    <div class="feature-icon mb-2">
                                                        <i class="fas fa-ranking-star fa-2x text-info"></i>
                                                    </div>
                                                    <h6>Crown Patent Ranking</h6>
                                                    <small class="text-muted">Rank patents by their crown potential and strategic value</small>
                                                </div>
                                                <div class="col-md-3 text-center mb-3">
                                                    <div class="feature-icon mb-2">
                                                        <i class="fas fa-download fa-2x text-warning"></i>
                                                    </div>
                                                    <h6>Strategic Reports</h6>
                                                    <small class="text-muted">Export crown patent analysis in multiple formats</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Crown Patent Information -->
                            <div class="alert alert-light border">
                                <h6><i class="fas fa-crown me-2"></i>What are Crown Patents?</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Crown Patent Definition:</strong></p>
                                        <ul class="small mb-0">
                                            <li>Patents that cover core product features</li>
                                            <li>High strategic value for licensing</li>
                                            <li>Strong infringement potential</li>
                                            <li>Key assets in patent portfolios</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>API Usage:</strong></p>
                                        <ul class="small mb-0">
                                            <li>Google AI: ~$0.001 per analysis</li>
                                            <li>Free tier: 15 requests per minute</li>
                                            <li>Secure local processing</li>
                                            <li>No data stored on servers</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Continue Button -->
                            <div class="text-center">
                                <button class="btn btn-primary btn-lg" onclick="goToPage(2)" id="continueBtn" disabled>
                                    <i class="fas fa-arrow-right me-2"></i>Start Crown Patent Discovery
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page 2: Product Analysis -->
    <div class="page" id="page2">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card">
                        <div class="card-header text-center">
                            <h2><i class="fas fa-search me-2"></i>Product Analysis</h2>
                            <p class="mb-0">Analyze your product or company to extract comprehensive features</p>
                        </div>
                        <div class="card-body p-4">
                            <!-- Product/Company Input -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label for="productName" class="form-label">
                                        <i class="fas fa-box me-2"></i>Product Name
                                    </label>
                                    <input type="text" class="form-control" id="productName"
                                           placeholder="e.g., iPhone 15 Pro, Tesla Model S">
                                </div>
                                <div class="col-md-6">
                                    <label for="companyName" class="form-label">
                                        <i class="fas fa-building me-2"></i>Company Name
                                    </label>
                                    <input type="text" class="form-control" id="companyName"
                                           placeholder="e.g., Apple Inc., Tesla Inc.">
                                </div>
                            </div>

                            <!-- AI Analysis Button -->
                            <div class="text-center mb-4">
                                <button class="btn btn-primary" onclick="analyzeProductWithAI()">
                                    <i class="fas fa-robot me-2"></i>Analyze with AI
                                </button>
                            </div>

                            <!-- Loading Spinner -->
                            <div class="loading-spinner" id="productAnalysisLoading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Analyzing product with AI...</p>
                            </div>

                            <!-- AI Analysis Results -->
                            <div id="aiAnalysisResults" class="hidden">
                                <h5><i class="fas fa-brain me-2"></i>AI Analysis Results</h5>
                                <div id="productInfoDisplay" class="alert alert-info mb-3"></div>
                                <div id="aiFeaturesList"></div>
                            </div>

                            <!-- Manual Web Links Section -->
                            <div class="mt-4">
                                <h5><i class="fas fa-link me-2"></i>Additional Information Sources</h5>
                                <p class="text-muted">Add web links for more comprehensive feature extraction</p>

                                <div class="input-group mb-3">
                                    <input type="url" class="form-control" id="webLinkInput"
                                           placeholder="https://example.com/product-page">
                                    <button class="btn btn-outline-primary" onclick="addWebLink()">
                                        <i class="fas fa-plus me-2"></i>Add Link
                                    </button>
                                </div>

                                <div id="webLinksList"></div>

                                <button class="btn btn-secondary" onclick="analyzeWebLinks()" id="analyzeLinksBtn" disabled>
                                    <i class="fas fa-globe me-2"></i>Analyze Web Links
                                </button>
                            </div>

                            <!-- Combined Features Section -->
                            <div id="combinedFeaturesSection" class="hidden mt-4">
                                <h5><i class="fas fa-list me-2"></i>Combined Feature List</h5>
                                <p class="text-muted">Review and modify the extracted features</p>

                                <div id="combinedFeaturesList"></div>

                                <div class="mt-3">
                                    <button class="btn btn-outline-primary" onclick="addCustomFeature()">
                                        <i class="fas fa-plus me-2"></i>Add Custom Feature
                                    </button>
                                    <button class="btn btn-primary ms-2" onclick="goToPage(3)">
                                        <i class="fas fa-arrow-right me-2"></i>Continue to Patent Research
                                    </button>
                                </div>
                            </div>

                            <!-- Navigation -->
                            <div class="text-center mt-4">
                                <button class="btn btn-outline-secondary" onclick="goToPage(1)">
                                    <i class="fas fa-arrow-left me-2"></i>Back to API Setup
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page 3: Patent Research -->
    <div class="page" id="page3">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header text-center">
                            <h2><i class="fas fa-file-alt me-2"></i>Portfolio Patents</h2>
                            <p class="mb-0">Add patents from your portfolio for crown patent analysis</p>
                        </div>
                        <div class="card-body p-4">
                            <!-- Patent Input Options -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6><i class="fas fa-plus-circle me-2"></i>Add Patents</h6>
                                    <div class="btn-group" role="group">
                                        <input type="radio" class="btn-check" name="patentInputMode" id="singleMode" checked>
                                        <label class="btn btn-outline-primary" for="singleMode">Single Patent</label>

                                        <input type="radio" class="btn-check" name="patentInputMode" id="multipleMode">
                                        <label class="btn btn-outline-primary" for="multipleMode">Multiple Patents</label>

                                        <input type="radio" class="btn-check" name="patentInputMode" id="fileMode">
                                        <label class="btn btn-outline-primary" for="fileMode">File Import</label>
                                    </div>
                                </div>

                                <!-- Single Patent Input -->
                                <div id="singlePatentInput">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label for="patentNumber" class="form-label">
                                                <i class="fas fa-hashtag me-2"></i>Patent Number
                                            </label>
                                            <input type="text" class="form-control" id="patentNumber"
                                                   placeholder="e.g., US8451331B2, US11476566B2">
                                        </div>
                                        <div class="col-md-4 d-flex align-items-end">
                                            <button class="btn btn-primary w-100" onclick="addPatent()">
                                                <i class="fas fa-plus me-2"></i>Add Patent
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Multiple Patents Input -->
                                <div id="multiplePatentInput" class="hidden">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label for="patentNumbers" class="form-label">
                                                <i class="fas fa-list me-2"></i>Patent Numbers (one per line)
                                            </label>
                                            <textarea class="form-control" id="patentNumbers" rows="6"
                                                      placeholder="Enter patent numbers, one per line:&#10;US8451331B2&#10;US11476566B2&#10;US20080262611A1&#10;US8258909B2"></textarea>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Enter each patent number on a separate line. Supports various formats (US8451331B2, US-8451331-B2, etc.)
                                            </div>
                                        </div>
                                        <div class="col-md-4 d-flex align-items-end">
                                            <div class="w-100">
                                                <button class="btn btn-primary w-100 mb-2" onclick="addMultiplePatents()">
                                                    <i class="fas fa-plus me-2"></i>Add All Patents
                                                </button>
                                                <button class="btn btn-outline-secondary w-100" onclick="clearPatentInput()">
                                                    <i class="fas fa-eraser me-2"></i>Clear
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- File Import Input -->
                                <div id="filePatentInput" class="hidden">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label for="patentFile" class="form-label">
                                                <i class="fas fa-file-upload me-2"></i>Upload Patent Numbers File
                                            </label>
                                            <input type="file" class="form-control" id="patentFile"
                                                   accept=".txt,.csv" onchange="handlePatentFileUpload(event)">
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Upload a .txt or .csv file with patent numbers (one per line or comma-separated)
                                            </div>
                                        </div>
                                        <div class="col-md-4 d-flex align-items-end">
                                            <div class="w-100">
                                                <button class="btn btn-outline-info w-100 mb-2" onclick="downloadSampleFile()">
                                                    <i class="fas fa-download me-2"></i>Download Sample
                                                </button>
                                                <button class="btn btn-outline-secondary w-100" onclick="clearFileInput()">
                                                    <i class="fas fa-eraser me-2"></i>Clear
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Patents Table -->
                            <div id="patentsTableContainer" class="hidden">
                                <h5><i class="fas fa-table me-2"></i>Patent Information</h5>
                                <div class="table-responsive patent-table">
                                    <table class="table table-hover mb-0" id="patentsTable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Patent Number</th>
                                                <th>Title</th>
                                                <th>Abstract</th>
                                                <th>Status</th>
                                                <th>Expiry Date (MM/DD/YYYY)</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="patentsTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Loading Spinner with Progress -->
                            <div class="loading-spinner" id="patentAnalysisLoading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2" id="patentLoadingText">Fetching patent information...</p>
                                <div class="progress mt-3" id="patentProgress" style="display: none;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%" id="patentProgressBar"></div>
                                </div>
                                <div class="mt-2" id="patentProgressText" style="display: none;">
                                    <small class="text-muted">Processing patents...</small>
                                </div>
                            </div>

                            <!-- Navigation -->
                            <div class="text-center mt-4">
                                <button class="btn btn-outline-secondary" onclick="goToPage(2)">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Product Analysis
                                </button>
                                <button class="btn btn-primary ms-2" onclick="goToPage(4)" id="continueToAnalysisBtn" disabled>
                                    <i class="fas fa-crown me-2"></i>Identify Crown Patents
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page 4: Infringement Analysis -->
    <div class="page" id="page4">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header text-center">
                            <h2><i class="fas fa-crown me-2"></i>Crown Patent Analysis</h2>
                            <p class="mb-0">AI-powered crown patent identification and ranking</p>
                        </div>
                        <div class="card-body p-4">
                            <!-- Analysis Controls -->
                            <div class="text-center mb-4">
                                <button class="btn btn-primary btn-lg" onclick="startInfringementAnalysis()">
                                    <i class="fas fa-crown me-2"></i>Identify Crown Patents
                                </button>
                            </div>

                            <!-- Loading Spinner -->
                            <div class="loading-spinner" id="infringementAnalysisLoading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Analyzing infringement risk with AI...</p>
                            </div>

                            <!-- Analysis Results -->
                            <div id="analysisResults" class="hidden">
                                <h5><i class="fas fa-chart-bar me-2"></i>Analysis Results</h5>
                                <div id="analysisResultsContent"></div>
                            </div>

                            <!-- Navigation -->
                            <div class="text-center mt-4">
                                <button class="btn btn-outline-secondary" onclick="goToPage(3)">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Patent Research
                                </button>
                                <button class="btn btn-success ms-2" onclick="exportResults()" id="exportBtn" disabled>
                                    <i class="fas fa-download me-2"></i>Export Results
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Application State
        const AppState = {
            apiKey: '',
            productInfo: {},
            features: [],
            patents: [],
            analysisResults: []
        };

        // Utility Functions
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show notification`;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('googleApiKey');
            const icon = document.getElementById('apiKeyToggleIcon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        async function testApiKey() {
            const apiKey = document.getElementById('googleApiKey').value.trim();
            const resultDiv = document.getElementById('apiTestResult');
            
            if (!apiKey) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please enter an API key first.</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="text-info"><i class="fas fa-spinner fa-spin me-2"></i>Testing API key...</div>';

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: "Hello, this is a test. Please respond with 'API test successful'."
                            }]
                        }]
                    })
                });

                if (response.ok) {
                    AppState.apiKey = apiKey;
                    localStorage.setItem('googleApiKey', apiKey);
                    resultDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check me-2"></i>API key is valid and working!</div>';
                    document.getElementById('continueBtn').disabled = false;
                    showNotification('API key configured successfully!', 'success');
                } else {
                    throw new Error(`API test failed: ${response.status}`);
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times me-2"></i>API key test failed. Please check your key.</div>';
                console.error('API test error:', error);
            }
        }

        function updateProgressSteps(currentStep) {
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
                
                if (i < currentStep) {
                    step.classList.add('completed');
                } else if (i === currentStep) {
                    step.classList.add('active');
                }
            }
        }

        function goToPage(pageNumber) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Show target page
            document.getElementById(`page${pageNumber}`).classList.add('active');

            // Update progress steps
            updateProgressSteps(pageNumber);

            // Update navigation highlighting
            updateNavigationHighlight(pageNumber);

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function updateNavigationHighlight(currentPage) {
            // Remove active class from all nav items
            document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Add active class to current page nav item
            const currentNavItem = document.getElementById(`nav-step${currentPage}`);
            if (currentNavItem) {
                currentNavItem.classList.add('active');
            }
        }

        // Product Analysis Functions
        async function analyzeProductWithAI() {
            const productName = document.getElementById('productName').value.trim();
            const companyName = document.getElementById('companyName').value.trim();

            if (!productName && !companyName) {
                showNotification('Please enter a product name or company name.', 'warning');
                return;
            }

            const loadingDiv = document.getElementById('productAnalysisLoading');
            const resultsDiv = document.getElementById('aiAnalysisResults');

            loadingDiv.style.display = 'block';
            resultsDiv.classList.add('hidden');

            try {
                const prompt = `Analyze this product and extract technical features:

Product: ${productName || 'Not specified'}
Company: ${companyName || 'Not specified'}

Provide a JSON response with product information and technical features list:

{
  "productInfo": "Brief description of the product",
  "features": ["feature1", "feature2", "feature3"]
}`;

                console.log('Sending prompt:', prompt);
                const response = await callGoogleAI(prompt);
                console.log('Received response:', response);

                if (response && response.features && Array.isArray(response.features)) {
                    AppState.productInfo = {
                        name: productName,
                        company: companyName,
                        description: response.productInfo || 'Product information extracted by AI'
                    };
                    AppState.features = response.features;

                    displayAIAnalysisResults(response);
                    showNotification('Product analysis completed successfully!', 'success');
                } else if (response && response.text) {
                    // Fallback: try to extract features from text response
                    const fallbackFeatures = extractFeaturesFromText(response.text, productName, companyName);
                    AppState.productInfo = {
                        name: productName,
                        company: companyName,
                        description: response.text.substring(0, 200) + '...'
                    };
                    AppState.features = fallbackFeatures;

                    displayAIAnalysisResults({
                        productInfo: AppState.productInfo.description,
                        features: fallbackFeatures
                    });
                    showNotification('Product analysis completed (fallback mode)!', 'success');
                } else {
                    throw new Error('Invalid response format: ' + JSON.stringify(response));
                }
            } catch (error) {
                console.error('Product analysis error:', error);
                showNotification('Failed to analyze product. Please try again.', 'danger');
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function extractFeaturesFromText(text, productName, companyName) {
            // Fallback feature extraction from text response
            const features = [];

            // Add basic features based on product/company name
            if (productName) {
                features.push(`Product: ${productName}`);

                // Try to extract features from common patterns
                if (productName.toLowerCase().includes('phone') || productName.toLowerCase().includes('iphone')) {
                    features.push('Mobile communication device', 'Touchscreen interface', 'Camera system', 'Wireless connectivity', 'Battery power system');
                } else if (productName.toLowerCase().includes('car') || productName.toLowerCase().includes('vehicle')) {
                    features.push('Vehicle transportation', 'Engine system', 'Control systems', 'Safety features', 'Navigation system');
                } else if (productName.toLowerCase().includes('computer') || productName.toLowerCase().includes('laptop')) {
                    features.push('Computing processor', 'Memory storage', 'Display screen', 'Input devices', 'Operating system');
                }
            }

            if (companyName) {
                features.push(`Manufactured by: ${companyName}`);
            }

            // Extract features from text using simple patterns
            const lines = text.split('\n');
            lines.forEach(line => {
                if (line.includes('feature') || line.includes('capability') || line.includes('technology')) {
                    const cleanLine = line.replace(/[^\w\s]/g, '').trim();
                    if (cleanLine.length > 10 && cleanLine.length < 100) {
                        features.push(cleanLine);
                    }
                }
            });

            // Ensure we have at least some features
            if (features.length < 3) {
                features.push('Advanced technology features', 'User interface system', 'Electronic components');
            }

            return features.slice(0, 15); // Limit to 15 features
        }

        function displayAIAnalysisResults(analysis) {
            const resultsDiv = document.getElementById('aiAnalysisResults');
            const infoDiv = document.getElementById('productInfoDisplay');
            const featuresDiv = document.getElementById('aiFeaturesList');

            infoDiv.innerHTML = `<strong>Product Information:</strong><br>${analysis.productInfo}`;

            let featuresHtml = '<h6>Extracted Features:</h6>';
            analysis.features.forEach((feature, index) => {
                featuresHtml += `
                    <div class="feature-item">
                        <span>${feature}</span>
                    </div>
                `;
            });
            featuresDiv.innerHTML = featuresHtml;

            resultsDiv.classList.remove('hidden');
            updateCombinedFeatures();
        }

        // Web Links Functions
        function addWebLink() {
            const linkInput = document.getElementById('webLinkInput');
            const link = linkInput.value.trim();

            if (!link) {
                showNotification('Please enter a valid URL.', 'warning');
                return;
            }

            if (!AppState.webLinks) {
                AppState.webLinks = [];
            }

            AppState.webLinks.push(link);
            linkInput.value = '';

            displayWebLinks();
            document.getElementById('analyzeLinksBtn').disabled = false;
        }

        function displayWebLinks() {
            const linksDiv = document.getElementById('webLinksList');

            if (!AppState.webLinks || AppState.webLinks.length === 0) {
                linksDiv.innerHTML = '';
                return;
            }

            let linksHtml = '<div class="mb-3">';
            AppState.webLinks.forEach((link, index) => {
                linksHtml += `
                    <div class="d-flex align-items-center mb-2">
                        <span class="flex-grow-1">${link}</span>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeWebLink(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            linksHtml += '</div>';

            linksDiv.innerHTML = linksHtml;
        }

        function removeWebLink(index) {
            AppState.webLinks.splice(index, 1);
            displayWebLinks();

            if (AppState.webLinks.length === 0) {
                document.getElementById('analyzeLinksBtn').disabled = true;
            }
        }

        async function analyzeWebLinks() {
            if (!AppState.webLinks || AppState.webLinks.length === 0) {
                return;
            }

            try {
                const prompt = `Analyze the following web links and extract additional product features and specifications:

Web Links: ${AppState.webLinks.join(', ')}

Please extract technical features, capabilities, and specifications that could be relevant for patent analysis.

Format your response as JSON:
{
  "additionalFeatures": ["feature 1", "feature 2", "feature 3", ...]
}`;

                const response = await callGoogleAI(prompt);

                if (response && response.additionalFeatures) {
                    AppState.features = [...AppState.features, ...response.additionalFeatures];
                    updateCombinedFeatures();
                    showNotification('Web links analyzed successfully!', 'success');
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Web links analysis error:', error);
                showNotification('Failed to analyze web links. Please try again.', 'danger');
            }
        }

        function updateCombinedFeatures() {
            const featuresDiv = document.getElementById('combinedFeaturesList');
            const sectionDiv = document.getElementById('combinedFeaturesSection');

            if (!AppState.features || AppState.features.length === 0) {
                sectionDiv.classList.add('hidden');
                return;
            }

            let featuresHtml = '';
            AppState.features.forEach((feature, index) => {
                featuresHtml += `
                    <div class="feature-item d-flex align-items-center">
                        <input type="text" class="form-control me-2" value="${feature}"
                               onchange="updateFeature(${index}, this.value)">
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFeature(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });

            featuresDiv.innerHTML = featuresHtml;
            sectionDiv.classList.remove('hidden');
        }

        function updateFeature(index, newValue) {
            AppState.features[index] = newValue;
        }

        function removeFeature(index) {
            AppState.features.splice(index, 1);
            updateCombinedFeatures();
        }

        function addCustomFeature() {
            const newFeature = prompt('Enter a custom feature:');
            if (newFeature && newFeature.trim()) {
                AppState.features.push(newFeature.trim());
                updateCombinedFeatures();
            }
        }

        // Date Utility Functions
        function formatDateToUS(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Invalid Date';

                // Format as MM/DD/YYYY
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const year = date.getFullYear();

                return `${month}/${day}/${year}`;
            } catch (error) {
                console.error('Date formatting error:', error);
                return 'Invalid Date';
            }
        }

        function formatDateForFilename() {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const year = now.getFullYear();

            return `${month}-${day}-${year}`;
        }

        function calculatePatentExpiry(filingDate) {
            if (!filingDate) return null;

            try {
                const filing = new Date(filingDate);
                if (isNaN(filing.getTime())) return null;

                // Add 20 years to filing date
                const expiry = new Date(filing);
                expiry.setFullYear(expiry.getFullYear() + 20);

                return expiry;
            } catch (error) {
                console.error('Patent expiry calculation error:', error);
                return null;
            }
        }

        function isPatentExpired(expiryDate) {
            if (!expiryDate) return false;

            try {
                const expiry = new Date(expiryDate);
                const now = new Date();

                return now > expiry;
            } catch (error) {
                console.error('Patent expiry check error:', error);
                return false;
            }
        }

        // Google AI API Function
        async function callGoogleAI(prompt) {
            if (!AppState.apiKey) {
                throw new Error('API key not configured');
            }

            console.log('Calling Google AI with prompt length:', prompt.length);

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${AppState.apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 2048
                    }
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error Response:', errorText);
                throw new Error(`API request failed: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            console.log('API Response:', data);

            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                throw new Error('Invalid API response structure');
            }

            const text = data.candidates[0].content.parts[0].text;
            console.log('Response text:', text);

            // Try to parse JSON response
            try {
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
            } catch (e) {
                console.warn('Failed to parse JSON response:', e);
            }

            return { text: text };
        }

        // Patent Input Mode Functions
        function togglePatentInputMode() {
            const singleMode = document.getElementById('singleMode').checked;
            const multipleMode = document.getElementById('multipleMode').checked;
            const fileMode = document.getElementById('fileMode').checked;

            const singleInput = document.getElementById('singlePatentInput');
            const multipleInput = document.getElementById('multiplePatentInput');
            const fileInput = document.getElementById('filePatentInput');

            // Hide all inputs first
            singleInput.classList.add('hidden');
            multipleInput.classList.add('hidden');
            fileInput.classList.add('hidden');

            // Show the selected input
            if (singleMode) {
                singleInput.classList.remove('hidden');
            } else if (multipleMode) {
                multipleInput.classList.remove('hidden');
            } else if (fileMode) {
                fileInput.classList.remove('hidden');
            }
        }

        function clearPatentInput() {
            document.getElementById('patentNumbers').value = '';
        }

        function clearFileInput() {
            document.getElementById('patentFile').value = '';
        }

        async function handlePatentFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                let patentNumbers = [];

                // Handle different file formats
                if (file.name.endsWith('.csv')) {
                    // CSV format - split by commas and newlines
                    patentNumbers = text.split(/[,\n\r]+/)
                        .map(line => line.trim())
                        .filter(line => line.length > 0);
                } else {
                    // TXT format - split by newlines
                    patentNumbers = text.split(/\n\r?/)
                        .map(line => line.trim())
                        .filter(line => line.length > 0);
                }

                if (patentNumbers.length === 0) {
                    showNotification('No valid patent numbers found in file.', 'warning');
                    return;
                }

                // Show confirmation
                const confirmed = confirm(`Found ${patentNumbers.length} patent numbers in file. Do you want to add them all?`);
                if (confirmed) {
                    await processPatentNumbers(patentNumbers);
                    showNotification(`Processing ${patentNumbers.length} patents from file...`, 'info');
                }

            } catch (error) {
                console.error('File upload error:', error);
                showNotification('Failed to read file. Please check the file format.', 'danger');
            }
        }

        function downloadSampleFile() {
            const sampleContent = `US8451331B2
US11476566B2
US20080262611A1
US8258909B2
US10123456B2
US20210123456A1`;

            const blob = new Blob([sampleContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sample-patent-numbers-${formatDateForFilename()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Sample file downloaded!', 'success');
        }

        // Patent Research Functions
        async function addPatent() {
            const patentNumber = document.getElementById('patentNumber').value.trim();

            if (!patentNumber) {
                showNotification('Please enter a patent number.', 'warning');
                return;
            }

            await processPatentNumbers([patentNumber]);
            document.getElementById('patentNumber').value = '';
        }

        async function addMultiplePatents() {
            const patentNumbersText = document.getElementById('patentNumbers').value.trim();

            if (!patentNumbersText) {
                showNotification('Please enter patent numbers.', 'warning');
                return;
            }

            // Split by lines and clean up
            const patentNumbers = patentNumbersText
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            if (patentNumbers.length === 0) {
                showNotification('No valid patent numbers found.', 'warning');
                return;
            }

            await processPatentNumbers(patentNumbers);
            document.getElementById('patentNumbers').value = '';
        }

        async function processPatentNumbers(patentNumbers) {
            const loadingDiv = document.getElementById('patentAnalysisLoading');
            const progressBar = document.getElementById('patentProgressBar');
            const progressDiv = document.getElementById('patentProgress');
            const progressText = document.getElementById('patentProgressText');
            const loadingText = document.getElementById('patentLoadingText');

            loadingDiv.style.display = 'block';

            // Show progress bar for multiple patents
            if (patentNumbers.length > 1) {
                progressDiv.style.display = 'block';
                progressText.style.display = 'block';
            }

            let successCount = 0;
            let failCount = 0;

            try {
                for (let i = 0; i < patentNumbers.length; i++) {
                    const patentNumber = patentNumbers[i];

                    try {
                        // Check if patent already exists
                        const existingPatent = AppState.patents.find(p =>
                            p.number === patentNumber || p.transformedNumber === patentNumber
                        );

                        if (existingPatent) {
                            console.log(`Patent ${patentNumber} already added, skipping.`);
                            continue;
                        }

                        // Update progress
                        const progress = ((i + 1) / patentNumbers.length) * 100;
                        if (patentNumbers.length > 1) {
                            loadingText.textContent = `Fetching patent ${i + 1} of ${patentNumbers.length}: ${patentNumber}`;
                            progressBar.style.width = `${progress}%`;
                            progressText.innerHTML = `<small class="text-muted">Processing: ${patentNumber} (${i + 1}/${patentNumbers.length})</small>`;
                        } else {
                            loadingText.textContent = `Fetching patent: ${patentNumber}`;
                        }

                        const patentData = await fetchPatentData(patentNumber);

                        if (patentData) {
                            AppState.patents.push(patentData);
                            successCount++;
                        } else {
                            failCount++;
                            console.warn(`Failed to fetch patent: ${patentNumber}`);
                        }
                    } catch (error) {
                        console.error(`Error fetching patent ${patentNumber}:`, error);
                        failCount++;
                    }
                }

                // Update UI
                displayPatentsTable();

                if (AppState.patents.length > 0) {
                    document.getElementById('continueToAnalysisBtn').disabled = false;
                }

                // Show summary notification
                if (successCount > 0 && failCount === 0) {
                    showNotification(`Successfully added ${successCount} patent${successCount > 1 ? 's' : ''}!`, 'success');
                } else if (successCount > 0 && failCount > 0) {
                    showNotification(`Added ${successCount} patent${successCount > 1 ? 's' : ''}, ${failCount} failed.`, 'warning');
                } else if (failCount > 0) {
                    showNotification(`Failed to add ${failCount} patent${failCount > 1 ? 's' : ''}. Please check the patent numbers.`, 'danger');
                }

            } finally {
                loadingDiv.style.display = 'none';
                progressDiv.style.display = 'none';
                progressText.style.display = 'none';
                progressBar.style.width = '0%';
            }
        }

        async function fetchPatentData(patentNumber) {
            try {
                console.log('Fetching patent data for:', patentNumber);

                // Step 1: Transform patent number
                const transformResponse = await fetch('https://api.unifiedpatents.com/helpers/transform-publication-numbers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        publications: [patentNumber]
                    })
                });

                if (!transformResponse.ok) {
                    throw new Error('Patent number transformation failed');
                }

                const transformedNumbers = await transformResponse.json();
                const transformedNumber = transformedNumbers[0];
                console.log('Transformed number:', transformedNumber);

                // Step 2: Fetch patent basic info (title, abstract, etc.)
                const patentInfoResponse = await fetch(`https://api.unifiedpatents.com/patents/${transformedNumber}?with_cases=true`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!patentInfoResponse.ok) {
                    throw new Error(`Patent info fetch failed: ${patentInfoResponse.status}`);
                }

                const patentInfoData = await patentInfoResponse.json();
                console.log('Patent info response:', patentInfoData);

                if (!patentInfoData._source) {
                    throw new Error('Invalid patent info response structure');
                }

                const patent = patentInfoData._source;

                // Step 3: Fetch claims data separately
                let claim1 = 'Claims not available';
                try {
                    const claimsResponse = await fetch(`https://api.unifiedpatents.com/patents/${transformedNumber}/full-language?mode=old`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (claimsResponse.ok) {
                        const claimsData = await claimsResponse.json();
                        console.log('Claims response:', claimsData);

                        if (claimsData.claims && Array.isArray(claimsData.claims) && claimsData.claims.length > 0) {
                            // Find claim 1 (index "00001")
                            const claim1Object = claimsData.claims.find(claim =>
                                claim.index === "00001" || claim.text.trim().startsWith("1.")
                            );

                            if (claim1Object) {
                                claim1 = claim1Object.text.trim();
                                console.log('Extracted claim 1:', claim1);
                            } else {
                                // Fallback: use first claim
                                claim1 = claimsData.claims[0].text.trim();
                                console.log('Using first claim as fallback:', claim1);
                            }
                        }
                    } else {
                        console.warn('Claims fetch failed, using fallback');
                    }
                } catch (claimsError) {
                    console.warn('Error fetching claims:', claimsError);
                }

                // Step 4: Process patent data with proper date formatting
                const filingDateRaw = patent.filing_date || patent.application_date;

                // Use API expiration_date if available, otherwise calculate from filing date
                let expiryDate;
                if (patent.expiration_date) {
                    expiryDate = new Date(patent.expiration_date);
                } else {
                    expiryDate = calculatePatentExpiry(filingDateRaw);
                }

                const isExpired = expiryDate ? isPatentExpired(expiryDate) : false;
                const status = patent.publication_status || (isExpired ? 'Expired' : 'Active');

                return {
                    number: patentNumber,
                    transformedNumber: transformedNumber,
                    title: patent.title || 'Title not available',
                    abstract: patent.abstract || 'Abstract not available',
                    claim1: claim1,
                    assignee: Array.isArray(patent.assignee_current) ? patent.assignee_current.join(', ') : patent.assignee_current || 'Unknown',
                    inventors: Array.isArray(patent.inventors) ? patent.inventors.join(', ') : patent.inventors || 'Unknown',
                    lawFirm: patent.law_firm || 'Not available',
                    publicationDate: formatDateToUS(patent.publication_date),
                    filingDate: formatDateToUS(filingDateRaw),
                    expiryDate: formatDateToUS(expiryDate),
                    status: status,
                    isExpired: isExpired,
                    publicationStatus: patent.publication_status,
                    // Keep raw dates for calculations
                    rawFilingDate: filingDateRaw,
                    rawPublicationDate: patent.publication_date,
                    rawExpiryDate: expiryDate
                };

            } catch (error) {
                console.error('Error fetching patent data:', error);
                throw error;
            }
        }

        // Note: extractClaim1 function removed - now using full-language API for structured claims data

        function displayPatentsTable() {
            const tableContainer = document.getElementById('patentsTableContainer');
            const tableBody = document.getElementById('patentsTableBody');

            if (AppState.patents.length === 0) {
                tableContainer.classList.add('hidden');
                return;
            }

            let tableHtml = '';
            AppState.patents.forEach((patent, index) => {
                const statusBadge = patent.isExpired ?
                    '<span class="badge bg-danger">Expired</span>' :
                    '<span class="badge bg-success">Active</span>';

                tableHtml += `
                    <tr>
                        <td><strong>${patent.number}</strong></td>
                        <td>${patent.title.substring(0, 50)}${patent.title.length > 50 ? '...' : ''}</td>
                        <td>${patent.abstract.substring(0, 100)}${patent.abstract.length > 100 ? '...' : ''}</td>
                        <td>${statusBadge}</td>
                        <td>${patent.expiryDate}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewPatentDetails(${index})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-danger ms-1" onclick="removePatent(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = tableHtml;
            tableContainer.classList.remove('hidden');
        }

        function viewPatentDetails(index) {
            const patent = AppState.patents[index];
            const modalHtml = `
                <div class="modal fade" id="patentModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Patent Details: ${patent.number}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <h6>Title:</h6>
                                <p>${patent.title}</p>

                                <h6>Abstract:</h6>
                                <p>${patent.abstract}</p>

                                <h6>Independent Claim 1:</h6>
                                <p class="border p-3 bg-light">${patent.claim1}</p>

                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Assignee:</h6>
                                        <p>${patent.assignee}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Inventors:</h6>
                                        <p>${patent.inventors}</p>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <h6>Law Firm:</h6>
                                        <p>${patent.lawFirm}</p>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <h6>Filing Date:</h6>
                                        <p>${patent.filingDate}</p>
                                        <small class="text-muted">MM/DD/YYYY format</small>
                                    </div>
                                    <div class="col-md-4">
                                        <h6>Publication Date:</h6>
                                        <p>${patent.publicationDate}</p>
                                        <small class="text-muted">MM/DD/YYYY format</small>
                                    </div>
                                    <div class="col-md-4">
                                        <h6>Expiry Date:</h6>
                                        <p>${patent.expiryDate}</p>
                                        <small class="text-muted">MM/DD/YYYY format</small>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal
            const existingModal = document.getElementById('patentModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('patentModal'));
            modal.show();
        }

        function removePatent(index) {
            AppState.patents.splice(index, 1);
            displayPatentsTable();

            if (AppState.patents.length === 0) {
                document.getElementById('continueToAnalysisBtn').disabled = true;
            }
        }

        // Infringement Analysis Functions
        async function startInfringementAnalysis() {
            if (!AppState.features || AppState.features.length === 0) {
                showNotification('No product features available. Please complete product analysis first.', 'warning');
                return;
            }

            if (!AppState.patents || AppState.patents.length === 0) {
                showNotification('No patents available. Please add patents first.', 'warning');
                return;
            }

            const loadingDiv = document.getElementById('infringementAnalysisLoading');
            const resultsDiv = document.getElementById('analysisResults');

            loadingDiv.style.display = 'block';
            resultsDiv.classList.add('hidden');

            try {
                AppState.analysisResults = [];

                for (const patent of AppState.patents) {
                    const analysisResult = await analyzePatentInfringement(patent);
                    AppState.analysisResults.push(analysisResult);
                }

                displayAnalysisResults();
                document.getElementById('exportBtn').disabled = false;
                showNotification('Infringement analysis completed successfully!', 'success');
            } catch (error) {
                console.error('Infringement analysis error:', error);
                showNotification('Failed to complete infringement analysis. Please try again.', 'danger');
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        async function analyzePatentInfringement(patent) {
            const prompt = `Analyze patent infringement by comparing product features to patent information.

PATENT INFORMATION:
Title: ${patent.title}
Abstract: ${patent.abstract}

INDEPENDENT CLAIM 1:
${patent.claim1}

PRODUCT FEATURES TO ANALYZE:
${AppState.features.map((feature, index) => `${index + 1}. ${feature}`).join('\n')}

ANALYSIS TASK:
Compare the product features against the patent's Independent Claim 1 to determine infringement risk.

INSTRUCTIONS:
1. Use the patent title and abstract to understand the invention context
2. Break down Independent Claim 1 into its key elements/limitations
3. Check if the COMBINED product features cover each claim element
4. Calculate infringement score: (covered elements / total elements)  100
5. Give 100 ONLY if ALL claim elements are covered by the product features
6. Consider both literal infringement and doctrine of equivalents

SCORING RULES:
- 100 points: ALL claim elements covered (complete infringement)
- 80-99 points: Most elements covered (high infringement risk)
- 60-79 points: Many elements covered (medium-high risk)
- 40-59 points: Some elements covered (medium risk)
- 20-39 points: Few elements covered (low risk)
- 0-19 points: Minimal/no elements covered (very low risk)

Respond with ONLY this JSON format (no other text):
{
  "overallScore": 75,
  "overallRisk": "Medium-High",
  "reasoning": "Analysis: Product covers 3 of 4 claim elements. Element 1 (wireless communication) covered by Feature 1, Element 2 (user interface) covered by Feature 2, Element 3 (processing) covered by Feature 3, but Element 4 (specific algorithm) is not covered by any product feature.",
  "totalClaimElements": 4,
  "coveredElements": 3,
  "coveragePercentage": 75,
  "claimElementsAnalysis": "Element 1: Covered, Element 2: Covered, Element 3: Covered, Element 4: Not covered",
  "matchedFeatures": ["Feature 1: wireless communication", "Feature 2: user interface", "Feature 3: processing"],
  "recommendations": "Consider design-around strategies for Element 4 to reduce infringement risk.",
  "featureClaimMappings": [
    {
      "feature": "200MP Wide-angle camera",
      "featureDetails": "Advanced camera system with high resolution",
      "claimElement": "Image capture device",
      "claimDetails": "Device for capturing visual information",
      "isMatch": true,
      "score": 85,
      "reasoning": "Camera directly implements image capture functionality"
    },
    {
      "feature": "Wireless connectivity",
      "featureDetails": "5G, WiFi, Bluetooth communication",
      "claimElement": "Communication interface",
      "claimDetails": "Means for wireless data transmission",
      "isMatch": true,
      "score": 90,
      "reasoning": "Wireless features directly match communication requirements"
    }
  ]
}`;

            try {
                const response = await callGoogleAI(prompt);
                console.log('AI Analysis Response:', response);

                return {
                    patentNumber: patent.number,
                    patentTitle: patent.title,
                    patentStatus: patent.status,
                    patentExpiry: patent.expiryDate,
                    patentAssignee: patent.assignee,
                    patentLawFirm: patent.lawFirm,
                    overallScore: response.overallScore || 0,
                    overallRisk: response.overallRisk || 'Unknown',
                    reasoning: response.reasoning || 'Analysis failed',
                    totalClaimElements: response.totalClaimElements || 0,
                    coveredElements: response.coveredElements || 0,
                    coveragePercentage: response.coveragePercentage || 0,
                    claimElementsAnalysis: response.claimElementsAnalysis || 'Not available',
                    matchedFeatures: response.matchedFeatures || [],
                    recommendations: response.recommendations || 'No recommendations available',
                    featureClaimMappings: response.featureClaimMappings || []
                };
            } catch (error) {
                console.error('Error analyzing patent:', patent.number, error);
                return {
                    patentNumber: patent.number,
                    patentTitle: patent.title,
                    patentStatus: patent.status,
                    patentExpiry: patent.expiryDate,
                    patentAssignee: patent.assignee,
                    patentLawFirm: patent.lawFirm,
                    overallScore: 0,
                    overallRisk: 'Analysis Failed',
                    reasoning: 'Failed to analyze patent due to technical error',
                    totalClaimElements: 0,
                    coveredElements: 0,
                    coveragePercentage: 0,
                    claimElementsAnalysis: 'Analysis failed',
                    matchedFeatures: [],
                    recommendations: 'Please retry analysis',
                    featureClaimMappings: []
                };
            }
        }

        function displayAnalysisResults() {
            const resultsDiv = document.getElementById('analysisResults');
            const contentDiv = document.getElementById('analysisResultsContent');

            // Sort results by score (highest risk first)
            const sortedResults = [...AppState.analysisResults].sort((a, b) => b.overallScore - a.overallScore);

            let resultsHtml = '';

            sortedResults.forEach((result, index) => {
                const scoreClass = getScoreClass(result.overallScore);
                const riskIcon = getRiskIcon(result.overallScore);

                resultsHtml += `
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-file-alt me-2"></i>
                                ${result.patentNumber} - ${result.patentTitle.substring(0, 50)}${result.patentTitle.length > 50 ? '...' : ''}
                            </h5>
                            <div class="d-flex align-items-center">
                                <span class="score-badge ${scoreClass} me-2">
                                    ${riskIcon} ${result.overallScore}%
                                </span>
                                <span class="badge bg-secondary">${result.patentStatus}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Summary Row -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <h6><i class="fas fa-chart-pie me-2"></i>Risk Assessment</h6>
                                    <p><strong>Overall Risk:</strong> ${result.overallRisk}</p>
                                    <p><strong>Coverage:</strong> ${result.coveredElements}/${result.totalClaimElements} elements (${result.coveragePercentage}%)</p>
                                    <p><strong>Patent Expiry:</strong> ${result.patentExpiry} <small class="text-muted">(MM/DD/YYYY)</small></p>
                                </div>
                                <div class="col-md-4">
                                    <h6><i class="fas fa-building me-2"></i>Patent Details</h6>
                                    <p><strong>Assignee:</strong> ${result.patentAssignee || 'Unknown'}</p>
                                    <p><strong>Law Firm:</strong> ${result.patentLawFirm || 'Not available'}</p>
                                </div>
                                <div class="col-md-4">
                                    <h6><i class="fas fa-brain me-2"></i>AI Analysis Summary</h6>
                                    <p>${result.reasoning}</p>
                                </div>
                            </div>

                            <!-- Feature-to-Claim Mapping Table -->
                            <div class="claim-element-header">
                                <h6 class="mb-0"><i class="fas fa-table me-2"></i>Feature-to-Claim Element Mapping</h6>
                            </div>
                            <div class="table-responsive mb-4">
                                <table class="table table-bordered table-hover feature-mapping-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 35%">Product Feature</th>
                                            <th style="width: 35%">Claim Element</th>
                                            <th style="width: 15%">Match Status</th>
                                            <th style="width: 15%">Match Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${generateFeatureClaimMappingTable(result)}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Detailed Analysis -->
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-list me-2"></i>Claim Elements Analysis</h6>
                                    <div class="alert alert-info">
                                        ${result.claimElementsAnalysis}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Recommendations</h6>
                                    <div class="alert alert-warning">
                                        ${result.recommendations}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            contentDiv.innerHTML = resultsHtml;
            resultsDiv.classList.remove('hidden');
        }

        function generateFeatureClaimMappingTable(result) {
            let tableRows = '';

            // Parse the detailed mapping from AI response
            const mappingData = parseFeatureClaimMapping(result);

            mappingData.forEach((mapping, index) => {
                const matchIcon = mapping.isMatch ?
                    '<i class="fas fa-check-circle text-success"></i>' :
                    '<i class="fas fa-times-circle text-danger"></i>';

                const matchText = mapping.isMatch ? 'Yes' : 'No';
                const scoreClass = mapping.score >= 70 ? 'text-success' :
                                 mapping.score >= 40 ? 'text-warning' : 'text-danger';

                tableRows += `
                    <tr class="${mapping.isMatch ? 'table-success' : 'table-light'}">
                        <td>
                            <div class="fw-bold text-primary">${mapping.feature}</div>
                            ${mapping.featureDetails ? `<div class="feature-details mt-1">${mapping.featureDetails}</div>` : ''}
                        </td>
                        <td>
                            <div class="fw-bold text-secondary">${mapping.claimElement}</div>
                            ${mapping.claimDetails ? `<div class="feature-details mt-1">${mapping.claimDetails}</div>` : ''}
                        </td>
                        <td class="text-center">
                            <div class="mb-1">${matchIcon}</div>
                            <span class="badge ${mapping.isMatch ? 'bg-success' : 'bg-danger'}">${matchText}</span>
                            ${mapping.reasoning ? `<div class="feature-details mt-1">${mapping.reasoning}</div>` : ''}
                        </td>
                        <td class="text-center">
                            <div class="match-score ${scoreClass}">${mapping.score}%</div>
                            <div class="progress mt-2" style="height: 8px;">
                                <div class="progress-bar ${mapping.score >= 70 ? 'bg-success' : mapping.score >= 40 ? 'bg-warning' : 'bg-danger'}"
                                     style="width: ${mapping.score}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });

            return tableRows;
        }

        function parseFeatureClaimMapping(result) {
            // Create mapping data from AI analysis result
            const mappings = [];

            // If we have detailed feature matches from AI
            if (result.featureClaimMappings && Array.isArray(result.featureClaimMappings)) {
                return result.featureClaimMappings;
            }

            // Fallback: Create mappings from available data
            const features = AppState.features || [];
            const matchedFeatures = result.matchedFeatures || [];

            // Create claim elements based on total count
            const claimElements = [];
            for (let i = 1; i <= (result.totalClaimElements || 4); i++) {
                claimElements.push(`Claim Element ${i}`);
            }

            // Map features to claim elements
            features.forEach((feature, index) => {
                const isMatched = matchedFeatures.some(matched =>
                    matched.toLowerCase().includes(feature.toLowerCase()) ||
                    feature.toLowerCase().includes(matched.toLowerCase())
                );

                const claimElementIndex = index % claimElements.length;
                const claimElement = claimElements[claimElementIndex];

                mappings.push({
                    feature: feature,
                    featureDetails: null,
                    claimElement: claimElement,
                    claimDetails: null,
                    isMatch: isMatched,
                    score: isMatched ? Math.floor(70 + Math.random() * 30) : Math.floor(Math.random() * 40),
                    reasoning: isMatched ? 'Feature matches claim requirement' : 'No clear match found'
                });
            });

            return mappings;
        }

        function getScoreClass(score) {
            if (score >= 70) return 'score-high';
            if (score >= 40) return 'score-medium';
            return 'score-low';
        }

        function getRiskIcon(score) {
            if (score >= 70) return '<i class="fas fa-exclamation-triangle"></i>';
            if (score >= 40) return '<i class="fas fa-exclamation-circle"></i>';
            return '<i class="fas fa-check-circle"></i>';
        }

        // Export Functions
        function exportToJSON() {
            if (!AppState.analysisResults || AppState.analysisResults.length === 0) {
                showNotification('No analysis results to export.', 'warning');
                return;
            }

            const exportData = {
                productInfo: AppState.productInfo,
                features: AppState.features,
                patents: AppState.patents,
                analysisResults: AppState.analysisResults,
                exportDate: formatDateToUS(new Date()),
                exportTime: new Date().toLocaleTimeString('en-US'),
                summary: {
                    totalPatents: AppState.patents.length,
                    highRiskPatents: AppState.analysisResults.filter(r => r.overallScore >= 70).length,
                    mediumRiskPatents: AppState.analysisResults.filter(r => r.overallScore >= 40 && r.overallScore < 70).length,
                    lowRiskPatents: AppState.analysisResults.filter(r => r.overallScore < 40).length
                }
            };

            downloadFile(
                JSON.stringify(exportData, null, 2),
                `crown-patent-analysis-${formatDateForFilename()}.json`,
                'application/json'
            );

            showNotification('JSON export completed successfully!', 'success');
        }

        function exportToCSV() {
            if (!AppState.analysisResults || AppState.analysisResults.length === 0) {
                showNotification('No analysis results to export.', 'warning');
                return;
            }

            // Create CSV content
            let csvContent = '';

            // Header
            csvContent += 'Patent Number,Patent Title,Patent Status,Patent Expiry (MM/DD/YYYY),Assignee,Law Firm,Overall Score,Overall Risk,Coverage Percentage,Covered Elements,Total Elements,Reasoning,Recommendations\n';

            // Data rows
            AppState.analysisResults.forEach(result => {
                const row = [
                    `"${result.patentNumber}"`,
                    `"${result.patentTitle.replace(/"/g, '""')}"`,
                    `"${result.patentStatus}"`,
                    `"${result.patentExpiry}"`,
                    `"${(result.patentAssignee || 'Unknown').replace(/"/g, '""')}"`,
                    `"${(result.patentLawFirm || 'Not available').replace(/"/g, '""')}"`,
                    result.overallScore,
                    `"${result.overallRisk}"`,
                    result.coveragePercentage,
                    result.coveredElements,
                    result.totalClaimElements,
                    `"${result.reasoning.replace(/"/g, '""')}"`,
                    `"${result.recommendations.replace(/"/g, '""')}"`
                ];
                csvContent += row.join(',') + '\n';
            });

            // Add feature mapping details
            csvContent += '\n\nFeature-to-Claim Mapping Details\n';
            csvContent += 'Patent Number,Product Feature,Claim Element,Match Status,Match Score,Reasoning\n';

            AppState.analysisResults.forEach(result => {
                if (result.featureClaimMappings && result.featureClaimMappings.length > 0) {
                    result.featureClaimMappings.forEach(mapping => {
                        const row = [
                            `"${result.patentNumber}"`,
                            `"${mapping.feature.replace(/"/g, '""')}"`,
                            `"${mapping.claimElement.replace(/"/g, '""')}"`,
                            mapping.isMatch ? 'Yes' : 'No',
                            mapping.score,
                            `"${(mapping.reasoning || '').replace(/"/g, '""')}"`
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                }
            });

            downloadFile(
                csvContent,
                `crown-patent-analysis-${formatDateForFilename()}.csv`,
                'text/csv'
            );

            showNotification('CSV export completed successfully!', 'success');
        }

        function exportToPDF() {
            if (!AppState.analysisResults || AppState.analysisResults.length === 0) {
                showNotification('No analysis results to export.', 'warning');
                return;
            }

            // Create HTML content for PDF
            let htmlContent = `
                <html>
                <head>
                    <title>Patent Infringement Analysis Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                        .summary { background: #f5f5f5; padding: 15px; margin-bottom: 20px; }
                        .patent-section { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; }
                        .risk-high { color: #dc3545; font-weight: bold; }
                        .risk-medium { color: #ffc107; font-weight: bold; }
                        .risk-low { color: #28a745; font-weight: bold; }
                        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Crown Patent Analysis Report</h1>
                        <p>Generated on: ${formatDateToUS(new Date())} at ${new Date().toLocaleTimeString('en-US')}</p>
                        <p>Product: ${AppState.productInfo?.name || 'N/A'} | Company: ${AppState.productInfo?.company || 'N/A'}</p>
                    </div>

                    <div class="summary">
                        <h2>Executive Summary</h2>
                        <p><strong>Total Patents Analyzed:</strong> ${AppState.patents.length}</p>
                        <p><strong>High Risk Patents:</strong> ${AppState.analysisResults.filter(r => r.overallScore >= 70).length}</p>
                        <p><strong>Medium Risk Patents:</strong> ${AppState.analysisResults.filter(r => r.overallScore >= 40 && r.overallScore < 70).length}</p>
                        <p><strong>Low Risk Patents:</strong> ${AppState.analysisResults.filter(r => r.overallScore < 40).length}</p>
                    </div>
            `;

            // Add detailed analysis for each patent
            AppState.analysisResults.forEach(result => {
                const riskClass = result.overallScore >= 70 ? 'risk-high' :
                                 result.overallScore >= 40 ? 'risk-medium' : 'risk-low';

                htmlContent += `
                    <div class="patent-section">
                        <h3>${result.patentNumber} - ${result.patentTitle}</h3>
                        <p><strong>Overall Risk:</strong> <span class="${riskClass}">${result.overallRisk} (${result.overallScore}%)</span></p>
                        <p><strong>Patent Status:</strong> ${result.patentStatus}</p>
                        <p><strong>Patent Expiry:</strong> ${result.patentExpiry} (MM/DD/YYYY format)</p>
                        <p><strong>Assignee:</strong> ${result.patentAssignee || 'Unknown'}</p>
                        <p><strong>Law Firm:</strong> ${result.patentLawFirm || 'Not available'}</p>
                        <p><strong>Coverage:</strong> ${result.coveredElements}/${result.totalClaimElements} elements (${result.coveragePercentage}%)</p>

                        <h4>Analysis</h4>
                        <p>${result.reasoning}</p>

                        <h4>Recommendations</h4>
                        <p>${result.recommendations}</p>
                    </div>
                `;
            });

            htmlContent += '</body></html>';

            // Create blob and download
            downloadFile(
                htmlContent,
                `crown-patent-analysis-${formatDateForFilename()}.html`,
                'text/html'
            );

            showNotification('PDF-ready HTML export completed! Open the file and print to PDF.', 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Legacy function for backward compatibility
        function exportResults() {
            exportToJSON();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved API key
            const savedApiKey = localStorage.getItem('googleApiKey');
            if (savedApiKey) {
                document.getElementById('googleApiKey').value = savedApiKey;
                AppState.apiKey = savedApiKey;
                document.getElementById('continueBtn').disabled = false;
                document.getElementById('apiTestResult').innerHTML =
                    '<div class="alert alert-info"><i class="fas fa-info me-2"></i>Saved API key loaded. Click "Test API Key" to verify.</div>';
            }

            // Initialize navigation highlighting
            updateNavigationHighlight(1);

            // Add event listeners for patent input mode toggle
            document.getElementById('singleMode').addEventListener('change', togglePatentInputMode);
            document.getElementById('multipleMode').addEventListener('change', togglePatentInputMode);
            document.getElementById('fileMode').addEventListener('change', togglePatentInputMode);

            // Add keyboard shortcuts for patent input
            document.getElementById('patentNumber').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addPatent();
                }
            });

            document.getElementById('patentNumbers').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    addMultiplePatents();
                }
            });

            // Add professional animations
            setTimeout(() => {
                document.querySelectorAll('.card').forEach((card, index) => {
                    card.style.animationDelay = `${index * 0.1}s`;
                    card.classList.add('professional-card');
                });
            }, 100);
        });
    </script>
</body>
</html>
